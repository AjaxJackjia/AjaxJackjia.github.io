<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,推送," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="IOS平台消息提醒目的移动端信息的及时更新，为最终用户方便地提供最新的信息。  本地和远程消息提示特点对用户（User）而言是一致的对用户而言，用户可以被三种方式通知：  屏幕的标语或者提示；  在app上方的数字标记；  出现提示、标语或者app上方数字时的提示音；   而且用户可以自由定制消息提示的方式。 所以从用户的角度来看，不管是本地还是远程的提示，都会用上面的三种方式来告诉用户，有你感兴">
<meta name="keywords" content="iOS,推送">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈iOS消息推送机制">
<meta property="og:url" content="http://yoursite.com/ios-push/index.html">
<meta property="og:site_name" content="Jack Jia">
<meta property="og:description" content="IOS平台消息提醒目的移动端信息的及时更新，为最终用户方便地提供最新的信息。  本地和远程消息提示特点对用户（User）而言是一致的对用户而言，用户可以被三种方式通知：  屏幕的标语或者提示；  在app上方的数字标记；  出现提示、标语或者app上方数字时的提示音；   而且用户可以自由定制消息提示的方式。 所以从用户的角度来看，不管是本地还是远程的提示，都会用上面的三种方式来告诉用户，有你感兴">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/push-example.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-roles.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-ssl-tls.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-identification.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-authentication.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-process.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-mechanism.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/weixin_APNs.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/weixin_push_process.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-provider-msg.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/push_msg.png">
<meta property="og:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-feedback-msg.jpeg">
<meta property="og:updated_time" content="2017-04-08T07:37:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅谈iOS消息推送机制">
<meta name="twitter:description" content="IOS平台消息提醒目的移动端信息的及时更新，为最终用户方便地提供最新的信息。  本地和远程消息提示特点对用户（User）而言是一致的对用户而言，用户可以被三种方式通知：  屏幕的标语或者提示；  在app上方的数字标记；  出现提示、标语或者app上方数字时的提示音；   而且用户可以自由定制消息提示的方式。 所以从用户的角度来看，不管是本地还是远程的提示，都会用上面的三种方式来告诉用户，有你感兴">
<meta name="twitter:image" content="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/push-example.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 浅谈iOS消息推送机制 | Jack Jia </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5e5d756ee86b47c3c2339a80b083f4a6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jack Jia</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">慵懒的探索者</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books" rel="section">
            
              <i class="menu-item-icon fa fa-book fa-fw"></i> <br />
            
            读书
          </a>
        </li>
      
        
        <li class="menu-item menu-item-xmind">
          <a href="/xmind" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            脑图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                浅谈iOS消息推送机制
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-20T16:55:33+08:00" content="2015-07-20">
              2015-07-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/移动开发/" itemprop="url" rel="index">
                    <span itemprop="name">移动开发</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/ios-push/" class="leancloud_visitors" data-flag-title="浅谈iOS消息推送机制">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="IOS平台消息提醒"><a href="#IOS平台消息提醒" class="headerlink" title="IOS平台消息提醒"></a>IOS平台消息提醒</h1><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>移动端信息的及时更新，为最终用户方便地提供最新的信息。</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/push-example.png" alt="iOS平台的消息提醒"></p>
<h2 id="本地和远程消息提示特点"><a href="#本地和远程消息提示特点" class="headerlink" title="本地和远程消息提示特点"></a>本地和远程消息提示特点</h2><h3 id="对用户（User）而言是一致的"><a href="#对用户（User）而言是一致的" class="headerlink" title="对用户（User）而言是一致的"></a>对用户（User）而言是一致的</h3><p>对用户而言，用户可以被三种方式通知：</p>
<ul>
<li><p>屏幕的标语或者提示；</p>
</li>
<li><p>在app上方的数字标记；</p>
</li>
<li><p>出现提示、标语或者app上方数字时的提示音；</p>
</li>
</ul>
<p>而且用户可以自由定制消息提示的方式。</p>
<p>所以从用户的角度来看，不管是本地还是远程的提示，都会用上面的三种方式来告诉用户，有你感兴趣的信息到达。</p>
<p>本地消息提示适合以下两种典型的应用，</p>
<ul>
<li><p>适用于基于时间的行为（Time-based Behaviors），例如日历提醒、to-do list；</p>
</li>
<li><p>适用于周期性地在后台运行的应用，例如，依靠服务器来获取数据和消息的应用可以在后台运行的同事向服务器拉取消息，然后以本地通知的形式提醒用户。</p>
</li>
</ul>
<p>本地消息提示具有三要素：</p>
<ul>
<li><p>调用时间（Scheduled time）我们必须在系统传递消息的时候指定触发的日期和时间，并且我们可以周期性地调用；</p>
</li>
<li><p>通知类型（Notification type）消息类型包括提示消息、默认行为按钮上面的文字、app上面的数字标号等等；</p>
</li>
<li><p>自定义数据（Custom data）这一项主要包括一些用户自定义数据的字典。</p>
</li>
</ul>
<h3 id="对应用（App）而言是不同的"><a href="#对应用（App）而言是不同的" class="headerlink" title="对应用（App）而言是不同的"></a>对应用（App）而言是不同的</h3><p>当应用在前台、后台或者没有运行时，系统调用的本地和远程消息提示接口是不同的。</p>
<p>远程消息提示是基于Client / Server模型的，iOS系统使用的是Apple Push Notification service（APNs）。</p>
<p>说一下两种获取消息方式的区别：</p>
<ul>
<li><p>定时轮询请求 polling：客户端每隔一段时间请求服务器端，主动拉取最新消息；没有使用长连接，信息到达客户端的时间根据轮询的时间而定，时间可能会比较长。</p>
</li>
<li><p>推送push：与服务器建立长连接，每当有新的消息，被动接受消息，通过这个长连接送达客户端，信息几乎实时到达。</p>
</li>
</ul>
<h1 id="Apple-Push-Notification-service-APNs"><a href="#Apple-Push-Notification-service-APNs" class="headerlink" title="Apple Push Notification service (APNs)"></a>Apple Push Notification service (APNs)</h1><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-roles.png" alt="APNs"></p>
<p>APNs是苹果远程消息提示机制的核心部分。苹果公司通过建立一个强大的推送服务器集群来保证IOS设备的消息传播，这样的做的好处：</p>
<ul>
<li><p>强大的服务器集群保证消息推送的质量。</p>
</li>
<li><p>苹果设备后台只需与APNs保持一个稳定的系统连接，就可以保证各种应用的消息推送，降低了系统消耗，提高了系统资源利用率。</p>
</li>
</ul>
<h2 id="IOS推送机制中的四种角色"><a href="#IOS推送机制中的四种角色" class="headerlink" title="IOS推送机制中的四种角色"></a>IOS推送机制中的四种角色</h2><ul>
<li><p>Provider：app后台服务器；</p>
</li>
<li><p>APNs：苹果的推送服务器集群；</p>
</li>
<li><p>iPhone：用户的iPhone设备；</p>
</li>
<li><p>Client App： 安装在iPhone上的app；</p>
</li>
</ul>
<p>整个的消息推送过程，简单来说，Provider将需要发送给用户iOS设备的消息发送到APNs服务器集群，然后APNs服务器再将消息推送到iOS设备上，然后iOS设备再通知到我们手机上安装的应用，设备以通知或者声音的形式通知用户。</p>
<h2 id="iOS推送的前提"><a href="#iOS推送的前提" class="headerlink" title="iOS推送的前提"></a>iOS推送的前提</h2><p>为了保证服务的安全可靠，苹果有一套完善的认证机制，主要体现在两个方面：</p>
<ul>
<li><p>物理连接上的认证 (SSL/TLS链接)</p>
</li>
<li><p>iPhone设备令牌（device_token）的认证</p>
</li>
</ul>
<h2 id="物理连接上的认证-（SSL-TLS链接）"><a href="#物理连接上的认证-（SSL-TLS链接）" class="headerlink" title="物理连接上的认证 （SSL/TLS链接）"></a>物理连接上的认证 （SSL/TLS链接）</h2><p>iPhone在开启push服务的时候，会连接APNs建立一条TLS加密链接。每一台正常的iPhone都有一个独有的设备证书（unique device certificate），而APNs也有一个服务器证书。两者建立的时候，会验证彼此的证书有效性。</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-ssl-tls.png" alt="SSL/TLS链接"></p>
<p>SSL/TLS建立过程：</p>
<ul>
<li><p>Device发出初始化请求，这被叫做ClientHello请求；</p>
</li>
<li><p>Server接收到请求之后，将Server端的证书发送给客户端，这被叫做ServerHello；</p>
</li>
<li><p>客户端回应，验证服务器证书，并将客户端证书发送给server端， 然后客户端握手结束；</p>
</li>
<li><p>服务器最后做出相应，服务器端握手结束，此时，TLS连接建立。</p>
</li>
</ul>
<p>TLS链接一旦建立，在没有数据的情况下，只需要每隔15分钟进行一次保活的握手，因此几乎不占流量。</p>
<p>而一旦因为意外原因导致链接中断，iPhone会不断重新尝试建立TLS链接，直到成功。</p>
<p>顺便说一下，每台 iPhone独有的设备证书和密钥的来历。正常的iPhone刷系统之后，是没有设备证书和密钥的。这就是为什么iPhone会需要连接到 iTunes上进行激活——激活过程中，Apple会分配给每台iPhone独一无二的设备证书(device certificate)和密钥(key)。</p>
<h2 id="iPhone设备令牌（device-token）"><a href="#iPhone设备令牌（device-token）" class="headerlink" title="iPhone设备令牌（device_token）"></a>iPhone设备令牌（device_token）</h2><p>APNs判断Push推送消息该发给哪台iPhone的依据是一个“目的iPhone的标识”，这个 标识就是device token(设备令牌)。</p>
<p>设备令牌是怎么生成的呢？</p>
<p>在iOS 8之后，iphone上的app在安装的时候必须要在iOS系统上注册使用通知的类型，只有注册过之后，才能正常使用系统的通知功能，否则无法正常显示消息。</p>
<p>由于设备令牌(device token)会发生变化，所以应用必须在每次启动时，也就是每次建立TLS 连接时，进行设备注册以获取最新的device token，APNS通过正常iPhone唯一的设备证书(unique device certificate)，并用令牌密钥(token key)加密生成device token。</p>
<p>在令牌生成了之后，APNS会把设备令牌(device token)返回给iPhone，而对应的app，则通过二进制的形式将返回来的设备令牌(device token)直接发送给它的Provider。这样，当Provider有Push消息要发送时，就会把对应帐号的设备令牌(device token)和消息一起发送给APNs，而APNs再依据设备令牌(device token)，找到相应TLS链接的iPhone，并发送相应的Push消息。</p>
<h2 id="IOS推送意外"><a href="#IOS推送意外" class="headerlink" title="IOS推送意外"></a>IOS推送意外</h2><p>需要注意的是，通过每次在应用启动的时候请求device token并且将它传递给app provider，可以确保provider对于该设备拥有最新的令牌。但是有几种情况会让推送发生意外：</p>
<ul>
<li><p>如果用户在其他机器上备份，用户必须重新app来获取新的消息。这是因为在重新备份或者重新安装系统的时候，device token会发生变化。</p>
</li>
<li><p>将device token缓存下来并传递给app的provider， 这种做法是不可取的。因为device token会过期，应该是在用到它的时候去获取它。</p>
</li>
</ul>
<h2 id="iPhone设备令牌（device-token）的认证步骤"><a href="#iPhone设备令牌（device-token）的认证步骤" class="headerlink" title="iPhone设备令牌（device_token）的认证步骤"></a>iPhone设备令牌（device_token）的认证步骤</h2><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-identification.png" alt="iPhone设备令牌（device_token）的认证步骤"></p>
<p>认证的主要步骤：</p>
<ul>
<li><p>Device连接APNs服务器并携带设备序列号</p>
</li>
<li><p>连接成功，APNs经过打包和处理产生device_token并返回给注册的Device</p>
</li>
<li><p>Device携带获取的device_token向我们自己的应用服务器注册</p>
</li>
<li><p>完成需要培推送的Device在APNs服务器和我们自己的应用服务器注册</p>
</li>
</ul>
<p>简而言之，上述两个过程可以用下图来表示。</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-authentication.png" alt="认证概述"></p>
<p>我们的设备和APNS服务器之间的通讯是基于SSL协议的TCP流通讯，二者之间维持一个长连接，</p>
<p>当从APNS服务器注册成功后，一定要将device_token发送给我们的应用服务器，</p>
<p>因为在推送过程中，首先是由我们的应用服务器将需要推送的消息结合device_token按指定格式（后面会提到）打包然后发送给APNS服务器，然后由APNS服务器推送给我们的设备。</p>
<h1 id="iOS推送流程"><a href="#iOS推送流程" class="headerlink" title="iOS推送流程"></a>iOS推送流程</h1><h2 id="iOS推送流程的主要步骤"><a href="#iOS推送流程的主要步骤" class="headerlink" title="iOS推送流程的主要步骤"></a>iOS推送流程的主要步骤</h2><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-process.png" alt="iOS推送流程的主要步骤"></p>
<ul>
<li><p>首先，安装了具有推送功能的应用，我们的设备在有网络的情况下会连接苹果推送服务器，连接过程中，APNS会验证device_token，连接成功后维持一个长连接；</p>
</li>
<li><p>Provider收到需要被推送的消息并结合被推送设备的device_token一起打包发送给APNS服务器；</p>
</li>
<li><p>APNS服务器将推送信息推送给指定device_token的设备；</p>
</li>
<li><p>设备收到推送消息后通知我们的应用程序并显示和提示用户（声音、弹出框）；</p>
</li>
</ul>
<h2 id="iOS推送的完整路径"><a href="#iOS推送的完整路径" class="headerlink" title="iOS推送的完整路径"></a>iOS推送的完整路径</h2><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-push-mechanism.png" alt="iOS推送的完整路径"></p>
<p>上图显示了我们的应用服务器将消息推送到我们的App的完整路径。</p>
<p>其实真正完成推送的是APNS服务器，我们自己的应用服务器只是将需要推送的消息告诉苹果服务器。</p>
<p>至于如何维护消息队列或如何保证消息能被推送到指定的设备上，这些都由APNs给我们做完了。</p>
<h2 id="iOS微信-APNs消息推送系统"><a href="#iOS微信-APNs消息推送系统" class="headerlink" title="iOS微信 APNs消息推送系统"></a>iOS微信 APNs消息推送系统</h2><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/weixin_APNs.png" alt="iOS微信 APNs消息推送系统"></p>
<p>因为APNs的服务器基本在美国，从国内到美国的国际链路经常会出现一些不稳定的情况，因此，对于一个大型的推送系统，异地容灾是必须有的。</p>
<p>微信建设了上海、深圳、香港和加拿大4个IDC互备的灾备系统，在实践中取得了较好的容灾效果。</p>
<p>微信APNs推送系统包括三部分，推送服务，推送队列，推送网关。</p>
<p>推送服务会按照用户UIN找到device token，然后按照推送内容和一些设置组合出推送消息，保存到推送队列。</p>
<p>推送队列存储推送消息，并对外发布队列的积压情况。</p>
<p>推送网关会向推送队列订阅队列的积压情况，根据不同的积压值采用不同的策略进行推送：</p>
<ul>
<li><p>i) 如果积压在合理阈值内，推送消息就主要从本地的网关发出，例如上海的消息优先从上海的网关发出，尽量减少延时也降低专线流量。</p>
</li>
<li><p>ii) 一旦出口异常，本地网关推送受阻，队列的积压超过阈值后，其他地方的网关就会来取走消息，走其他出口。</p>
</li>
</ul>
<h2 id="iOS微信消息推送过程"><a href="#iOS微信消息推送过程" class="headerlink" title="iOS微信消息推送过程"></a>iOS微信消息推送过程</h2><p>下面我们以微信作为app，来具体说一下消息推送的过程是怎样的。<br>我们在iphone上登陆微信，其实软件是先把登录信息发给微信的服务器。因此当iphone关闭微信的时候，微信服务器会继续为我们保留登录状态，此时当有人给微信发送消息时，就会触发PUSH。</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/weixin_push_process.png" alt="iOS微信消息推送过程"></p>
<p>工作流程分为三个阶段：</p>
<ul>
<li><p>第一阶段：微信服务器端把要发送的消息、目的iPhone的标识打包，发给APNS。 </p>
</li>
<li><p>第二阶段：APNs在自身的已注册Push服务的iPhone列表中，查找有相应标识的iPhone，并把消息发送到iPhone。 如果此时没有查找到相应的iPhone标识，那么APNs会为目标保留消息，直到iPhone重新与APNs建立连接，然后再把消息发送给iphone。APNs并不保证所有推送都能发给ClientApp，例如当用户一直不在线时，就只有最后发的那条通知可以被收到。因此，一些比较重要的数据是不能依赖APNs推送来传递的。</p>
</li>
<li><p>第三阶段：iPhone把发来的消息传递给相应的应用程序，并且按照设定弹出Push通知。</p>
</li>
</ul>
<h1 id="IOS推送消息结构"><a href="#IOS推送消息结构" class="headerlink" title="IOS推送消息结构"></a>IOS推送消息结构</h1><h2 id="Provider发送给APNs消息的具体格式"><a href="#Provider发送给APNs消息的具体格式" class="headerlink" title="Provider发送给APNs消息的具体格式"></a>Provider发送给APNs消息的具体格式</h2><p>下图所示的消息体就是Provider发送给APNs的具体格式，首先APNs会验证这个结构是否合法，然后提取其中的消息，并将消息发送到指定的设备。</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-provider-msg.png" alt="Provider发送给APNs消息的具体格式"></p>
<p>结构中包含五个部分：</p>
<ul>
<li><p>命令提示符；</p>
</li>
<li><p>device_token长度；</p>
</li>
<li><p>device_token字符串；</p>
</li>
<li><p>推送消息体长度；</p>
</li>
<li><p>推送消息体内容；</p>
</li>
</ul>
<h3 id="推送消息体内容"><a href="#推送消息体内容" class="headerlink" title="推送消息体内容"></a>推送消息体内容</h3><p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/push_msg.png" alt="推送消息体内容"></p>
<table>
<thead>
<tr>
<th style="text-align:center"><em>Key</em></th>
<th>&emsp;&emsp;&emsp;</th>
<th style="text-align:left"><em>Comment</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">alert</td>
<td></td>
<td style="text-align:left">如果包含这条属性，iOS将会显示一个标准的提示。（可以指定一个字符串作为提醒或作为字典的值.  如果指定了一个字符串, 它会变成有两个按钮的警报消息: 关闭和显示. 如果用户点击查看, 应用程序将会启动。另外, 你可以指定一个字典来作为提示的内容. ）</td>
</tr>
<tr>
<td style="text-align:center">badge</td>
<td></td>
<td style="text-align:left">如果包含这条属性，iOS将会显示一个标准的提示。 （可以指定一个字符串作为提醒或作为字典的值.  如果指定了一个字符串, 它会变成有两个按钮的警报消息: 关闭和显示. 如果用户点击查看, 应用程序将会启动。另外, 你可以指定一个字典来作为提示的内容. ）</td>
</tr>
<tr>
<td style="text-align:center">sound</td>
<td></td>
<td style="text-align:left">它是捆绑在应用程序的声音文件名。该声音文件会作为提示来播放。</td>
</tr>
</tbody>
</table>
<p><br><br>这其实就是个JSON结构体，alert标签的内容就是会显示在用户手机上的推送信息，badge显示的数量（注意是整型）是会在应用Icon右上角显示的数量，提示有多少条未读消息等，sound就是当推送信息送达是手机播放的声音，传defalut就标明使用系统默认声音。</p>
<h2 id="消息推送特殊情况"><a href="#消息推送特殊情况" class="headerlink" title="消息推送特殊情况"></a>消息推送特殊情况</h2><p>当我们将应用从设备卸载后，推送的消息改如何处理呢？</p>
<p>如何让APNS和Provider都知道不去向这台卸载了应用的设备推送消息呢？</p>
<p>针对这个问题，苹果使用的是Feedback service。</p>
<p>它是APNS的一部分，APNS会持续的更新Feedback service的列表，当我们的Provider将信息发给APNs推送到我们的设备时，如果这时设备无法将消息推送到指定的应用，就会向APNS服务器报告一个反馈信息，而这个信息就记录在feedback service中。</p>
<p>按照这种方式，Provider应该定时的去检测Feedback service的列表，然后删除在自己数据库中记录的存在于反馈列表中的device_token，从而不再向这些设备发送推送信息。</p>
<p>连接Feedback service的过程同样使用Socket的方式，连接上后，直接接收由APNs传输给我们的反馈列表，传输完成后断开连接，然后我们根据这个最新的反馈列表在更新我们自己的数据库，删除那些不再需要推送信息的设备的device_token。</p>
<p>从Feedback service读取的数据结构如图所示：</p>
<p><img src="http://7xk4nm.com1.z0.glb.clouddn.com/uploads/2015/7/ios-feedback-msg.jpeg" alt="从Feedback service读取的消息体数据结构"></p>
<p>结构中包含三个部分：</p>
<ul>
<li><p>第一部分是一个时间戳，记录的是设备失效后的时间信息；</p>
</li>
<li><p>第二个部分是device_token的长度；</p>
</li>
<li><p>第三部分就是失效的device_token，我们所要获取的就是第三部分，跟我们的数据库进行对比后，删除对应的device_token，下次不再向这些设备发送推送信息。</p>
</li>
</ul>
<h2 id="iOS应用对应的三种收发消息情况"><a href="#iOS应用对应的三种收发消息情况" class="headerlink" title="iOS应用对应的三种收发消息情况"></a>iOS应用对应的三种收发消息情况</h2><p>一个iOS应用，可以与服务器互相收发消息，针对iOS应用的状态，存在以下三种情况：</p>
<ul>
<li><p>1）若iOS应用为活动状态，刚与服务器保持一个长连接，客户端与服务器通过此连接收发消息。</p>
</li>
<li><p>2）若iOS应用为退出状态，长连接被断开，服务器向客户端发消息则通过APNs推送消息实现。</p>
</li>
<li><p>3）若iOS应用刚刚切至后台，还没有关闭，发现长连接并没有断开，服务器通过长连接向客户端发送消息还是能发出去，但是iOS应用只有重新切至前台时才能收到消息。</p>
</li>
</ul>
<p>针对第三种情况：</p>
<p>在应用切至后台时，并不断开连接，因为用户可能会马上切回来，如果每次切至后台都断开连接，感觉比较耗费资源。目前的做法是切至后台后向服务器发送消息说明已经不能接受消息，服务器收到此消息后再向客户端发消息时直接走推送。过一段时间之后，客户端可能会被终止，这时连接会被断开，但服务器的行为与客户端切至后台时的行为是一致的。</p>
<p>针对微信来看：</p>
<p>当微信从后台切到前台的时候，上方的状态会显示连接中。。。收取中。。。，由此可以判断在微信切换到后台，主动给provider发送消息说明当前的状态，然后provider根据微信状态选择走APNs发送消息，当连接断开，后台真正挂起任务的时候，服务器发送信息的方式仍然是APNs，前后两个状态是一致的。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><p><a href="https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html" target="_blank" rel="external">https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html</a></p>
</li>
<li><p><a href="http://xiaolife.com/wordpress/an-introduce-to-iphone-push/" target="_blank" rel="external">http://xiaolife.com/wordpress/an-introduce-to-iphone-push/</a></p>
</li>
<li><p><a href="http://blog.csdn.net/ryantang03/article/details/8482259" target="_blank" rel="external">http://blog.csdn.net/ryantang03/article/details/8482259</a></p>
</li>
<li><p><a href="http://blog.csdn.net/kylinbl/article/details/8965074" target="_blank" rel="external">http://blog.csdn.net/kylinbl/article/details/8965074</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html</a></p>
</li>
<li><p><a href="http://qyappchentao.sinaapp.com/apns-and-wechat/" target="_blank" rel="external">http://qyappchentao.sinaapp.com/apns-and-wechat/</a></p>
</li>
</ul>
<p>–EOF–</p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag">#iOS</a>
          
            <a href="/tags/推送/" rel="tag">#推送</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/linux-command-list/" rel="next" title="Linux 指令日常">
                <i class="fa fa-chevron-left"></i> Linux 指令日常
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/sorting-algorithm/" rel="prev" title="排序算法 && 查找算法 (1)">
                排序算法 && 查找算法 (1) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="Jack Jia" />
          <p class="site-author-name" itemprop="name">Jack Jia</p>
          <p class="site-description motion-element" itemprop="description">自由·至简·宁静</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/AjaxJackjia" target="_blank">
                  
                    <i class="fa fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#IOS平台消息提醒"><span class="nav-number">1.</span> <span class="nav-text">IOS平台消息提醒</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#目的"><span class="nav-number">1.1.</span> <span class="nav-text">目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#本地和远程消息提示特点"><span class="nav-number">1.2.</span> <span class="nav-text">本地和远程消息提示特点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对用户（User）而言是一致的"><span class="nav-number">1.2.1.</span> <span class="nav-text">对用户（User）而言是一致的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对应用（App）而言是不同的"><span class="nav-number">1.2.2.</span> <span class="nav-text">对应用（App）而言是不同的</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Apple-Push-Notification-service-APNs"><span class="nav-number">2.</span> <span class="nav-text">Apple Push Notification service (APNs)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS推送机制中的四种角色"><span class="nav-number">2.1.</span> <span class="nav-text">IOS推送机制中的四种角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS推送的前提"><span class="nav-number">2.2.</span> <span class="nav-text">iOS推送的前提</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#物理连接上的认证-（SSL-TLS链接）"><span class="nav-number">2.3.</span> <span class="nav-text">物理连接上的认证 （SSL/TLS链接）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iPhone设备令牌（device-token）"><span class="nav-number">2.4.</span> <span class="nav-text">iPhone设备令牌（device_token）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS推送意外"><span class="nav-number">2.5.</span> <span class="nav-text">IOS推送意外</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iPhone设备令牌（device-token）的认证步骤"><span class="nav-number">2.6.</span> <span class="nav-text">iPhone设备令牌（device_token）的认证步骤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS推送流程"><span class="nav-number">3.</span> <span class="nav-text">iOS推送流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS推送流程的主要步骤"><span class="nav-number">3.1.</span> <span class="nav-text">iOS推送流程的主要步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS推送的完整路径"><span class="nav-number">3.2.</span> <span class="nav-text">iOS推送的完整路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS微信-APNs消息推送系统"><span class="nav-number">3.3.</span> <span class="nav-text">iOS微信 APNs消息推送系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS微信消息推送过程"><span class="nav-number">3.4.</span> <span class="nav-text">iOS微信消息推送过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IOS推送消息结构"><span class="nav-number">4.</span> <span class="nav-text">IOS推送消息结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Provider发送给APNs消息的具体格式"><span class="nav-number">4.1.</span> <span class="nav-text">Provider发送给APNs消息的具体格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#推送消息体内容"><span class="nav-number">4.1.1.</span> <span class="nav-text">推送消息体内容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息推送特殊情况"><span class="nav-number">4.2.</span> <span class="nav-text">消息推送特殊情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS应用对应的三种收发消息情况"><span class="nav-number">4.3.</span> <span class="nav-text">iOS应用对应的三种收发消息情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文章"><span class="nav-number">5.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Jia</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=0.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=0.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("RpOyfsG0ugnDV6Fg5qbCXNOI-gzGzoHsz", "qa8bUqCM3LW1988c8GgO5XR4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
