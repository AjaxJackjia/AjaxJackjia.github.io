title: "TCP/IP基础知识(2)"
date: 2015-03-28 12:05:19
category: 
- 网络
tags:
- TCP/IP
- network
- 协议
- 网络
toc: true
---

# TCP/IP体系结构之TCP和UDP协议
-------------------------------
## 1. 概述

* 为了改善网际层数据报交付不可靠的情况，一种方法是对接收的数据报进行确认。但是IP层不提供这种支持，因为有些应用不需要。
* 运输层提供针对不同需求的服务：较高成本的面向连接的可靠运输服务及较简单的和更快速的不可靠运输服务。

**运输控制协议**(**TCP**)：是一个功能完备的运输协议，它面向连接，具有流控制、运输确认和重传机制。
**用户数据报协议**(**UDP**)：是一个简单、高效和快速的运输协议，但它是不可靠的。

-------------------------------

## 2. 端口

通常一个设备上运行不止一个应用，设备的IP地址为这些应用所共享。发送数据报的每个应用都具有相同的IP源地址，接收到的每个数据报都有相同的目的IP地址。为了使多个应用能使用TCP/IP栈，应用数据被运输层以复用和分用的方式进行运输。

<a class="cotent-img" href="/uploads/2015/3/tcpip_分层复用.png">
	<img src="/uploads/2015/3/tcpip_分层复用.png" alt="tcpip_分层复用" width="680">
</a>


### 端口地址

为了区分某些应用，运输层为每个进程分配不同的端口。从应用接收的数据被运输层封装，在此加入源和目的端口。在接收端，网际层接收数据报，并将数据传递给运输层，运输层使用目的端口将报文传递给正确的应用。

* 运输层的UDP和TCP协议为应用提供服务，端口地址16位，所以每种协议有65536个端口可用。
* 应用协议使用客户/服务器模型。启动通信的客户程序需要知道服务器应用程序的目的端口。服务器使用接收到的报文中的源端口获知客户端口。

<a class="cotent-img" href="/uploads/2015/3/tcpip_端口应用.png">
	<img src="/uploads/2015/3/tcpip_端口应用.png" alt="tcpip_端口应用" width="680">
</a>

TCP和UDP端口号分配可分成3个范围：

* 知名端口号(0~1023)：保留给通用的TCP/IP应用；
* 注册端口号(1024~49151)：其它应用可以注册使用的端口号；
* 动态/私有端口号(49152~65535)：不被管理，可以用于任何目的，可以被任何机构使用。

完全的端口号分配表由IANA维护，可以在[[该网站]](http://www.iana.org/assignments/port-numbers)查询到。

下图列举了常用的知名端口：
<a class="cotent-img" href="/uploads/2015/3/tcpip_知名端口.png">
	<img src="/uploads/2015/3/tcpip_知名端口.png" alt="tcpip_知名端口" width="680">
</a>

### TCP/IP套接字

* 套接字是一个通信端标识符，由IP地址和端口号决定；
* 套接字与TCP/IP应用程序接口(API)相关联，每个API功能都需要一个套接字作为标识符；
* 有两种类型的套接字：**流**（TCP）和**数据报**（UDP）；
* 两个设备之间交换数据可以描述为报文从某一设备上的套接字发送到另一设备上的套接字。两个套接字建立关联，标注为
$$ <200.136.112.75:2520,205.122.63.20:80> $$
* 可以建立多个套接字，以允许几个应用共享同一个设备的IP地址。另外，在一个设备上可以存在多个关联，即一个设备可以同时与其它设备有多个连接。
<a class="cotent-img" href="/uploads/2015/3/tcpip_套接字模型.png">
	<img src="/uploads/2015/3/tcpip_套接字模型.png" alt="tcpip_套接字模型" width="640">
</a>

-------------------------------

## 3. 用户数据报协议（UDP）

用户数据报协议(UDP)是为那些需要一种简单且快速的运输协议的应用而设计的。对这些应用来说，甚至可以不保证报文的交付和重复，或者重传也没有意义。

UDP只实现端口导址。提供了一个可选的效验和用于错误检测。其它工作都由网际协议完成。
<a class="cotent-img" href="/uploads/2015/3/tcpip_udp报文格式.png">
	<img src="/uploads/2015/3/tcpip_udp报文格式.png" alt="tcpip_udp报文格式" width="680">
</a>

### UDP报文格式说明
* **源端口(2字节)**：发送报文的应用进程的16位端口号。
* **目的端口(2字节)**：目的设备上的接收进程的16位端口号。
* **长度(2字节)**：整个UDP数据报的长度，包括首部和数据字段。
* **校验和(2字节)**：提供错误检测功能的16位校验和，可选项。
* **数据(可变长度)**：要发送的已封装应用报文。

### 基于UDP的应用
* 请求-应答应用
* 数据流应用

<a class="cotent-img" href="/uploads/2015/3/tcpip_udp应用.png">
	<img src="/uploads/2015/3/tcpip_udp应用.png" alt="tcpip_udp应用" width="680">
</a>

-------------------------------

## 4. 运输控制协议（TCP）

运输控制协议(TCP)是一种功能完备的面向连接的运输协议，具有流控制、运输确认和重传机制。

### TCP特点
* **面向连接**: 在设备之间发生数据传送之前，必须先建立一个连接。
* **多连接**: 允许一个设备有多个连接打开而不会产生冲突。
* **全双工**: 一旦建立了连接，数据可以在两个方向传送。
* **面向流**: 允许应用已连续字节流的方式发送数据，TCP必须将数据打包成块后再将其交给IP。
* **非结构化数据**: 将以字节流的形式传送的数据分割成原始的数据报。
* **可靠**: TCP保证所有发送的数据都能到达其目的地。
* **确认**: TCP发送的每个报文都需要被接收方确认。
* **流控制**: 当某设备以某个数率发送数据而接收设备来不及处理时，TCP提供一种机制，使接收设备能通知发送设备降低发送数率或停止发送。
* **进程编址**: 对于共享同一个IP地址的不同应用，TCP提供了一种标识每个应用和以复用方式将数据传给IP层的方法。在接收端，TCP以分用的方式将数据传给目的应用。这一编址机制由端口号来实现。

### TCP报文单元
* TCP提供字节流传送数据的方式，应用不需要关心如何打包数据才能将其传送给运输层。
* 虽然TCP是面向流的，但其下面的IP层却不是，所以TCP必须将接收到的流分割成合适的数据块，这些数据块被封装成“报文段”。
* TCP以流的形式接受来自应用层的数据，这一现实的直接含义是：使用TCP的应用所接收的数据是非结构化的。

<a class="cotent-img" href="/uploads/2015/3/tcpip_tcp报文段格式.png">
	<img src="/uploads/2015/3/tcpip_tcp报文段格式.png" alt="tcpip_tcp报文段格式" width="680">
</a>

### TCP报文格式说明
* **源端口**（2字节）：源设备上发送报文段的进程的16位端口号。一般来说，对于请求报文它是一个客户进程，对于应答报文它是一个服务器进程。
* **目的端口**（2字节）：目的设备上接收进程的16位端口号。一般来说，对于请求报文它是一个服务器进程，对于应答报文它是一个客户进程。
* **序号**（4字节）：由滑动窗口确认系统使用，作为报文段中的一个字节的序号。在SYN位置1的情况下（连接请求报文），它指示初始序号（ISN）。
* **确认号**（4字节）：若ACK位置1，该字段有效并包含设备用于对接收到的数据进行确认的确认号。
* **数据偏移**（4字节）：指示数据的开始位置与TCP报文段的开始处有多少个32位字的偏移量。
* **保留**（6位）：填充0。
* **控制位**（6位）：用于控制信息。
 - **URG**（紧急位，1位）：若置1，表示该报文段包含紧急数据，由紧急指针字段指示其位置。
 - **ACK**（确认位，1位）：若置1，表示该报文段是一个确认报文，并且确认号字段有效。
 - **PSH**（推送位，1位）：若置1，表示该报文段中的数据必须被立即发送并被推送给接收设备上的应用。否则，该数据将要等到更多的数据传给TCP，达到报文段长度后才被发送。
 - **RST**（复位位，1位）：若置1，表示发送者检测到一个问题并希望对连接进行复位。
 - **SYN**（同步位，1位）：若置1，表示该报文段请求对序号同步并建立一个连接。序号字段包含发送者用于该连接的初始序号（ISN）。
 - **FIN**（结束位，1位）：若置1，表示该报文段的发送者请求关闭连接。
* **窗口**（2字节）：用于流控制，指示该报文段的发送者在给定时间内能从其他设备接收的字节数。
* **校验和**（2字节）：16位校验和。
* **紧急指针**（2字节）：若URG位置1，该字段包含紧急数据后面的“正常”数据第一个字节的序号。
* **选项**（可变长度）：一组选择项。
* **填充**（可变长度）：若选项字段的长度不是32位的整数倍，则要用足够的0来填充首部。
* **数据**（可变长度）：报文段中要发送的数据字节。

### 报文段首部选项
* 选项类型(1字节)-指定选项的类型；
* 选项长度(1字节)-以字节为单位的整个选项的长度；
* 选项数据(可变长度)-选项中使用的数据。

选项字段有两种可能的格式：

<a class="cotent-img" href="/uploads/2015/3/tcpip_tcp报文段首部选项.png">
	<img src="/uploads/2015/3/tcpip_tcp报文段首部选项.png" alt="tcpip_tcp报文段首部选项" width="680">
</a>

### 常用的TCP选项

<a class="cotent-img" href="/uploads/2015/3/tcpip_常用TCP选项.png">
	<img src="/uploads/2015/3/tcpip_常用TCP选项.png" alt="tcpip_常用TCP选项" width="680">
</a>

### PUSH功能

数据从应用传到TCP层时，首先被缓存，然后构建长度适宜的报文段，并将其发送到IP层，报文段长度必须足够大。如果传输的数据很少，构不成合适的报文段，则数据一直要保存在缓冲区中。在有些应用中，，这种做法会产生负面影响。

为解决这一问题，应用传递的数据需要立即发送时，启用“PUSH”功能。TCP构建一个报文段，将其PSH控制位置1并发送出去。接收端收到报文并看到PSH位激活时，必须无延迟的将数据传给应用。

### URGENT功能

所有数据在重要性方面被平等对待，但有些情况下，某些重要紧急的信息必须在不等待其对应次序的情况下发送给接受者。

当一个应用调用“URGENT”功能时，TCP会构建一个能将其立即发送出去的报文段。该报文段中的URG控制位被置1。该报文段也可以与正常数据合在一起，由TCP首部紧急指针字段指示紧急数据的结束。

-----------------------------------------

--EOF--

